@model List<SelectListItem>

@{
    ViewData["Title"] = "Index";
}

<link href="~/Content/css/_StyleSheet.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/gh/djibe/material@4.6.2-1.0/css/material-plugins.min.css" rel="stylesheet">
<!-- ********************************************************* Cards *********************************************************************** -->
@*@Html.Partial("_SelectCompany")*@

<div class="row" style="margin-bottom: 10px;" id="bankBalance">

</div>


<!-- ********************************************************* Charts *********************************************************************** -->


<div class="row mt-4">
    <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
            <div class="card-body p-3">

                <div class="col-xl-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-1 text-right"></i>
                            <span style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;">المصروفات الشهرية</span>
                        </div>
                        <div id="chart_container" class="card-body barChart"><canvas id="bar_chart1" width="100%" height="100%"></canvas></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
            <div class="card-body p-3">

                <div class="col-xl-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-1 text-right"></i>
                            <span style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;">المبيعات الشهرية</span>
                        </div>
                        <div id="chart_container" class="card-body lineChart"><canvas id="line_chart1" width="100%" height="100%"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<form>
    <div class="row d-flex flex-row-reverse">
        <div class="col-md-12">
            <div class="card my-4">

                <div class="p-3" style="padding-bottom:25px;">
                    <div class="form-group text-center">
                        <div class="row d-flex flex-row mt-2">

                            <div class="form-group col-md-6">
                                @Html.DropDownList("n_customer_id", null, " اخـتـر الـعـمـيـل ", new { @class = "form-control select2-container form-select form-control", @id = "n_customer_id", @name = "n_customer_id" })
                            </div>

                            <div class="form-group col-md-6">
                                @Html.DropDownList("n_salesman_id", null, " اخـتـر الـمـنـدوب ", new { @class = "form-control select2-container form-select form-control", @id = "n_salesman_id", @name = "n_salesman_id" })
                            </div>

                            <div class="form-group col-md-12">
                                <div class="row" dir="rtl">
                                    <div class="col-md-6 mt-3">
                                        <label class="form-label" style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;"> من : </label>
                                        <input type="date" class="form-control" id="from" name="from" />
                                    </div>

                                    <div class="col-md-6 mt-3">
                                        <label class="form-label" style="font-family: 'Droid Arabic Kufi', serif; font-weight: bold;"> الى :  </label>
                                        <input type="date" class="form-control" id="to" name="to" />
                                    </div>
                                </div>
                            </div>

                            <div class="form-control col-md-12">
                                <div class="row align-items-center justify-content-center">
                                    <div class="col-md-4">
                                        <button type="button" class="form-control btn btn-success" onclick="DrawExpensesChart()">Refresh</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<!-- ********************************************************* End Charts **************************************************************** -->

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#n_customer_id").select2({ theme: 'filled' });
            $("#n_salesman_id").select2({ theme: 'filled' });

            LoadBalance("Xceer_14_2022");

            DrawExpensesChart(null);

            $("#CompId").on('change', function () {
                var _val = $("#CompId").val();
                $.ajax({
                    url: '@Url.Action("ReloadCustomersList", "Home")',
                    type: 'Get',
                    dataType: 'json',
                    data: { dataBase: _val },
                    success: function (data) {
                        var str = "<option value=''> اخـتـر الـعـمـيـل </option>";
                        $.each(data, function (index, val) {
                            str += "<option value='" + val.n_customer_id + "'>" + val.s_customer_name + "</option>";
                        });
                        $("#n_customer_id").html(str);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });

                $.ajax({
                    url: '@Url.Action("ReloadSalersList", "Home")',
                    type: 'Get',
                    dataType: 'json',
                    data: { dataBase: _val },
                    success: function (data) {
                        var str = "<option value=''> اخـتـر الـمـنـدوب </option>";
                        $.each(data, function (index, val) {
                            str += "<option value='" + val.n_salesman_id + "'>" + val.s_salesman_name + "</option>";
                        });
                        $("#n_salesman_id").html(str);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            });

            $("#CompId").on('change', function () {
                var _dataBase = $("#CompId").val();
                $("#bankBalance").empty();

                LoadBalance(_dataBase);
                DrawExpensesChart(_dataBase);
            });
        });

        function LoadBalance(database) {
            $.ajax({
                url: '@Url.Action("Balance","Home")',
                type: 'GET',
                dataType: 'json',
                data: { dataBase: database },
                success: function (data) {
                    $.each(data, function (i, val) {
                        $("#bankBalance").append(
                            '<div class="col-md-4 mb-4" id="myDiv">'
                            +   '<div class="card">'
                            +       '<div class="card-body p-3">'
                            +           '<div class="row">'
                            +               '<div class="col-8">'
                            +                   '<div class="numbers">'
                            +                       '<p class="text-lg mb-0 text-uppercase font-weight-bold" style="font-family: "Droid Arabic Kufi", serif;"> ' + val.s_TreasureName + ' </p >'
                            +                       '<h6 class="font-weight-bolder" style="letter-spacing: 3px;"> ' + val.s_Value + ' </h6 >'
                            +                   '</div>'
                            +               '</div>'
                            +               '<div class="col-4 text-end">'
                            +                   '<div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">'
                            +                       '<i class="fa fa-bank text-lg opacity-10" aria-hidden="true"></i>'
                            +                   '</div>'
                            +               '</div>'
                            +           '</div>'
                            +       '</div>'
                            +   '</div>'
                            +'</div>'
                        );
                    });
                },
                error: function (err) {
                    console.log(err);
                }
            });
        }

        function DateFormat(d) {
            var date = new Date(d);
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();

            return `${year}/${month}/${day}`;
        }

        function DrawExpensesChart(database) {
            $("#line_chart1").remove();
            $(".lineChart").append("<canvas id='line_chart1' width='100%' height='100%'></canvas>");

            $("#bar_chart1").remove();
            $(".barChart").append("<canvas id='bar_chart1' width='100%' height='100%'></canvas>");

            // Expenses Chart
            var f = $("#from").val(), t = $("#to").val(), customer = $("#n_customer_id").val(), saler = $("#n_salesman_id").val();
            $.ajax({
                url: '@Url.Action("ExpensesChart", "Home")',
                type: 'GET',
                data: { dataBase: database, from: f, to: t},
                success: function (data) {
                    var monthes = [], values = [];
                    $.each(data, function (index, value) {
                        monthes.push(value.month);
                        values.push(value.value);
                    });
                    new Chart("bar_chart1", {
                        type: "bar",
                        data: {
                            labels: monthes,
                            datasets: [{
                                data: values,
                                backgroundColor: ["red", "green", "blue", "purple", "pink", "primary"],
                                borderColor: ["red", "green", "blue"],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspecRatio: false,
                            scales: {
                                xAxes: [{ ticks: { beginAtZero: true } }],
                                yAxes: [{ ticks: { beginAtZero: true } }]
                            },
                            legend: { display: false }
                        }
                    });
                },
                error: function (err) {
                    console.log(err);
                }
            });

            $.ajax({
                url: '@Url.Action("SalerChart", "Home")',
                type: 'GET',
                data: { dataBase: database, from: f, to: t, customer: customer, saler: saler },
                success: function (data) {
                    var monthes = [], values = [];
                    $.each(data, function (index, val) {
                        monthes.push(val.nMonth);
                        values.push(val.nvalue);
                    });
                    new Chart("line_chart1", {
                        type: "line",
                        data: {
                            labels: monthes,
                            datasets: [{
                                data: values,
                                borderColor: 'rgb(75, 192, 192)',
                            }]
                        },
                        options: {
                            maintainAspecRatio: false,
                            scales: {
                                xAxes: [{ ticks: { beginAtZero: true } }],
                                yAxes: [{ ticks: { beginAtZero: true } }]
                            },
                            legend: { display: false }
                        },
                    });
                },
                error: function (err) {
                    console.log(err);
                }
            });
        }
    </script>
}