@{
    ViewBag.Title = "Index";
}

<link href="~/Content/css/_StyleSheet.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/gh/djibe/material@4.6.2-1.0/css/material-plugins.min.css" rel="stylesheet">


<div class="row">
    <div class="form-group col-md-12 d-flex justify-content-center">
        <div class="col-md-2 bg-white p-2" dir="rtl">
            @*<label class="form-label text-white" style="font-family: 'Droid Arabic Kufi', serif;font-size:1.4rem"> الفرع </label>*@
            @Html.DropDownList("n_branch_id", null, " اخـتـر الـفـرع ", htmlAttributes: new { @class = "form-control", @id = "n_branch_id", @name = "n_branch_id" })
        </div>
    </div>
</div>

<div class="row flex-row justify-content-center">
    <div class="col-xl-5 col-sm-6 mb-xl-0 mt-5">
        <div class="card">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-8">
                        <div class="numbers">
                            <p class="text-lg mb-0 text-uppercase font-weight-bold branchName" style="font-family: 'Droid Arabic Kufi', serif;">  </p>
                            <h6 class="font-weight-bolder customerBalance" style="letter-spacing:3px;">
                            </h6>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                            <i class="fas fa-chalkboard-teacher  text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row row1 flex-row justify-content-between mb-5">

</div>

<div class="row mt-4">
    <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
            <div class="card-body p-3">

                <div class="col-xl-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-1 text-right"></i>
                            <span style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;"> المصروفات الشهرية </span>
                        </div>
                        <div id="chart_container" class="card-body barChart"><canvas id="bar_chart1" width="100%" height="100%"></canvas></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
            <div class="card-body p-3">

                <div class="col-xl-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-1 text-right"></i>
                            <span style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;">المبيعات الشهرية</span>
                        </div>
                        <div id="chart_container" class="card-body lineChart"><canvas id="line_chart1" width="100%" height="100%"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form>
    <div class="row d-flex flex-row-reverse">
        <div class="col-md-12">
            <div class="card my-4">

                <div class="p-3" style="padding-bottom:25px;">
                    <div class="form-group text-center">
                        <div class="row d-flex flex-row mt-2">

                            <div class="form-group col-md-6">
                                @Html.DropDownList("n_customer_id", null, " اخـتـر الـعـمـيـل ", new { @class = "form-control", id = "n_customer_id" })
                            </div>

                            <div class="form-group col-md-6">
                                @Html.DropDownList("n_salesman_id", null, " اخـتـر الـمـنـدوب ", new { @class = "form-control", id = "n_salesman_id" })
                            </div>

                            <div class="form-group col-md-12">
                                <div class="row" dir="rtl">
                                    <div class="col-md-6 mt-3">
                                        <label class="form-label" style="font-family: 'Droid Arabic Kufi', serif;font-weight:bold;"> من : </label>
                                        <input type="date" class="form-control" id="from" name="from" />
                                    </div>

                                    <div class="col-md-6 mt-3">
                                        <label class="form-label" style="font-family: 'Droid Arabic Kufi', serif; font-weight: bold;"> الى :  </label>
                                        <input type="date" class="form-control" id="to" name="to" />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group col-md-12">
                                <div class="row d-flex align-items-center justify-content-center">
                                    <div class="col-md-4">
                                        <button type="button" class="form-control btn btn-success" onclick="ChartsData()">Refresh</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section scripts
{
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#n_branch_id").select2({ dir:"ltr",  theme: 'filled' });
            $("#n_customer_id").select2({ theme: 'filled' });
            $("#n_salesman_id").select2({ theme: 'filled' });

            $("#CompId").on('change', function () {
                var _val = $("#CompId").val();
                $.ajax({
                    url: '@Url.Action("ReloadCustomersList", "Branches")',
                    type: 'Get',
                    dataType: 'json',
                    data: { dataBase: _val },
                    success: function (data) {
                        var str = "<option value=''> اخـتـر الـعـمـيـل </option>";
                        $.each(data, function (index, val) {
                            str += "<option value='" + val.n_customer_id + "'>" + val.s_customer_name + "</option>";
                        });
                        $("#n_customer_id").html(str);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });

                $.ajax({
                    url: '@Url.Action("ReloadSalersList", "Branches")',
                    type: 'Get',
                    dataType: 'json',
                    data: { dataBase: _val },
                    success: function (data) {
                        var str = "<option value=''> اخـتـر الـمـنـدوب </option>";
                        $.each(data, function (index, val) {
                            str += "<option value='" + val.n_salesman_id + "'>" + val.s_salesman_name + "</option>";
                        });
                        $("#n_salesman_id").html(str);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            });

            $("#CompId").on('change', function () {
                var _val = $("#CompId").val();
                $.ajax({
                    url: '@Url.Action("GetBranches", "Branches")',
                    type: 'Get',
                    dataType: 'json',
                    data: { dataBase: _val },
                    success: function (data) {
                        var str = "<option value='0'> اخـتـر الـفـرع </option>";
                        $.each(data, function (index, val) {
                            str += "<option value='" + val.n_branch_id + "'>" + val.s_branch_name + "</option>";
                        });
                        $("#n_branch_id").html(str);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });

                $('.cardData').remove();
                GetCustomersBranchBalance(_val);
                GetTreasuresBrancheBalance(_val);
                ChartsData(_val);
            });

            $("#n_branch_id").on('change', function () {
                var _val = $("#CompId").val();
                $('.cardData').remove();
                GetCustomersBranchBalance(_val);
                GetTreasuresBrancheBalance(_val);
                ChartsData(_val);
                $("#n_branch_id").attr('disabled', true);
                setInterval(function () {
                    $("#n_branch_id").removeAttr("disabled");
                }, 3000);
            });

            // Get Customers
            GetCustomersBranchBalance(null);

            // Get Treasures
            GetTreasuresBrancheBalance(null);

            // Charts
            ChartsData(null);
        });

        function GetCustomersBranchBalance(database) {
            $.ajax({
                url: '@Url.Action("GetCustomersBalances", "Branches")',
                type: "GET",
                dataType: "json",
                data: { dataBase: database, branch: Number($("#n_branch_id").val()) },
                success: function (data) {
                    var name = [], values = [];
                    $.each(data, function (index, val) {
                        name.push(val.s_branch_name);
                        values.push(val.n_customer_balance);
                    });
                    $(".branchName").html("ارصدة العملاء " + name)
                    $(".customerBalance").html(values)
                }
            });
        }

        function GetTreasuresBrancheBalance(database) {
            $.ajax({
                url: '@Url.Action("GettreasuresBalance", "Branches")',
                type: "GET",
                dataType: "json",
                data: { dataBase: database, branch: Number($("#n_branch_id").val()) },
                success: function (data) {
                    var names = [], values = [];
                    $.each(data, function (i, val) {
                        if (val.n_treasure_balance != '') {
                            $('.row1').append(
                                '<div class="col-xl-5 col-sm-6 mb-xl-0 mt-5 cardData">'
                                    + '<div class="card">'
                                        + '<div class="card-body p-3">'
                                            + '<div class="row">'
                                                    + '<div class="col-8">'
                                                        + '<div class="numbers">'
                                                            + '<p class="text-lg mb-0 text-uppercase font-weight-bold" style="font-family: "Droid Arabic Kufi", serif;"> ' + val.s_cash_name + ' </p>'
                                                            + '<h6 class="font-weight-bolder" style="letter-spacing:3px;"> ' + val.n_treasure_balance + ' </h6>'
                                                        + '</div>'
                                                    + '</div>'
                                                    + '<div class="col-4 text-end">'
                                                    + '<div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">'
                                                        + '<i class="fas fa-hand-holding-usd text-lg opacity-10" aria-hidden="true"></i>'
                                                    + '</div>'
                                                + '</div>'
                                            + '</div>'
                                        + '</div>'
                                    + '</div>'
                                + '</div>'
                            );
                        } else{
                            $('.row1').append(
                                '<div class="col-xl-5 col-sm-6 mb-xl-0 mt-5 cardData">'
                                    + '<div class="card">'
                                        + '<div class="card-body p-3">'
                                            + '<div class="row">'
                                                + '<div class="col-8">'
                                                    + '<div class="numbers">'
                                                        + '<p class="text-lg mb-0 text-uppercase font-weight-bold" style="font-family: "Droid Arabic Kufi", serif;"> ' + val.s_cash_name + ' </p>'
                                                        + '<h6 class="font-weight-bolder" style="letter-spacing:3px;"> ' + 0.0 + ' </h6>'
                                                    + '</div>'
                                                + '</div>'
                                                + '<div class="col-4 text-end">'
                                                    + '<div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">'
                                                        + '<i class="fas fa-hand-holding-usd text-lg opacity-10" aria-hidden="true"></i>'
                                                    + '</div>'
                                                + '</div>'
                                            + '</div>'
                                        + '</div>'
                                    + '</div>'
                                + '</div>'
                            );
                        }
                    });
                }
            });
        }

        function ChartsData(database) {
            $("#bar_chart1").remove();
            $(".barChart").append("<canvas id='bar_chart1' width='100%' height='100%'></canvas>");

            $("#line_chart1").remove();
            $(".lineChart").append("<canvas id='line_chart1' width='100%' height='100%'></canvas>");

            // Expenses Chart
            var f = $("#from").val(), t = $("#to").val(), id = Number($("#n_branch_id").val()), customer = $("#n_customer_id").val(), saler = $("#n_salesman_id").val();
            $.ajax({
                url: '@Url.Action("ExpensesChart", "Branches")',
                type: 'GET',
                data: { dataBase: database,from: f, to: t, branchId: id },
                success: function (data) {
                    var monthes = [], values = [];
                    $.each(data, function (index, value) {
                        monthes.push(value.month);
                        values.push(value.value);
                    });
                    new Chart("bar_chart1", {
                        type: "bar",
                        data: {
                            labels: monthes,
                            datasets: [{
                                data: values,
                                backgroundColor: ["red", "green", "blue", "purple", "pink", "primary"],
                                borderColor: ["red", "green", "blue"],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspecRatio: false,
                            scales: {
                                xAxes: [{ ticks: { beginAtZero: true } }],
                                yAxes: [{ ticks: { beginAtZero: true } }]
                            },
                            legend: { display: false }
                        }
                    });
                },
                error: function (err) {
                    alert("some field have error data");
                }
            });

            $.ajax({
                url: '@Url.Action("SalerChart", "Branches")',
                type: 'GET',
                dataType: 'json',
                data: { dataBase: database, branchId: id, from: f, to: t, customerId: customer, salerId: saler },
                success: function (data) {
                    var monthes = [], values = [];
                    $.each(data, function (index, val) {
                        monthes.push(val.nMonth);
                        values.push(val.nvalue);
                    });
                    new Chart("line_chart1", {
                        type: "line",
                        data: {
                            labels: monthes,
                            datasets: [{
                                data: values,
                                borderColor: 'rgb(75, 192, 192)',
                            }]
                        },
                        options: {
                            maintainAspecRatio: false,
                            scales: {
                                xAxes: [{ ticks: { beginAtZero: true } }],
                                yAxes: [{ ticks: { beginAtZero: true } }]
                            },
                            legend: { display: false }
                        },
                    });
                },
                error: function (err) {
                    alert("some field have error data");
                }
            });
        }
    </script>
}